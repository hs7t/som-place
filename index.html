<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">

    <link rel="preload" href="sprites/elevator/elevator1.png" as="image">
    <link rel="preload" href="sprites/elevator/elevator2.png" as="image">
    <link rel="preload" href="sprites/elevator/elevator3.png" as="image">
    <link rel="preload" href="sprites/elevator/elevator4.png" as="image">

    <title>Supremely Uncomfortable Place</title>
  </head>

  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>

  <script>
    let state = {
      elevator: {
        clicks: 0,
        open: false,
      },
    }

    let elevatorMusic = new Howl({
      src: ['audio/elevator.m4a'],
      loop: true,
      volume: 0.3,
      onend: function() {
        console.log("Stopped elevator music")
      }
    })

    let elevatorWhirr = new Howl({
      src: ['audio/elevator-whirr.m4a'],
      loop: true,
      volume: 0.5,
      onend: function() {
        console.log("Stopped elevator music")
      }
    })


    async function wait(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function hideElement(element) {
      element.classList.add("hidden")
      element.setAttribute("inert", true)
    }

    function showElement(element) {
      element.classList.remove("hidden")
      element.removeAttribute("inert")
    }

    function switchScene(oldScene, nextScene, onSceneSwitch=undefined) {
      hideElement(oldScene)
      Howler.stop()
      showElement(nextScene)

      if (onSceneSwitch != undefined) {
        onSceneSwitch()
      }
    }

    async function playSequence(frames=[], msTimeout=100, element, onSequenceEnd=undefined) {
      for (let frame of frames) {
        element.setAttribute("src", frame.src)
        await wait(msTimeout)
      }

      if (onSequenceEnd) {
        onSequenceEnd()
      }
    }

    async function processElevatorClick() {
      if (state.elevator.open == false) {
        await playSequence([
          { src: "sprites/elevator/elevator1.png" },
          { src: "sprites/elevator/elevator2.png" },
          { src: "sprites/elevator/elevator3.png" },
          { src: "sprites/elevator/elevator4.png" },
        ], 100, document.querySelector(".elevator-img"))
        state.elevator.open = true;
      }

      await switchScene(document.querySelector(".start-section"), document.querySelector(".elevator-section"), loopRobSequence)
      elevatorMusic.play()
    }

    async function processElevatorButtonClick() {
      document.querySelector(".elevator-section").classList.add("whirring")
      elevatorMusic.pause()

      elevatorWhirr.play()
      elevatorWhirr.on('end', () => {
        document.querySelector(".elevator-section").classList.remove("whirring")
        switchScene(document.querySelector(".elevator-section"), document.querySelector(".start-section"))
      })
    }

    async function loopRobSequence() {
      await playSequence([
        { src: "sprites/rob/rob1.png" },
        { src: "sprites/rob/rob2.png" },
        { src: "sprites/rob/rob3.png" },
      ], 200, document.querySelector(".rob-img")) 

      setTimeout(loopRobSequence, 0)
    }

    function showDialog() {
      console.log("Open")
      document.querySelector("dialog").showModal()
    }
  </script>

  <style>
    * {
      box-sizing: border-box;
      --cursor-default: url("sprites/cursor1.png") 0 0, default;
      --cursor-pointer: url("sprites/cursor2.png") 0 0, pointer;
    }

    .hidden {
      display: none !important;
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    main {
      width: 100vw;
      height: 100vh;
      cursor: var(--cursor-default);

      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Pixelify Sans", monospace, sans-serif;

      image-rendering: pixelated;
      background-color: black;
    }

    img {
        -webkit-user-drag: none;
        user-drag: none;
        -webkit-user-select: none;
        -moz-user-select: none; 
        -ms-user-select: none; 
        user-select: none; 
    }

    section {
      display: flex;
      justify-content: center;
      position: relative;
    }

    .start-section {
      width: 100%;
      height: 100%;
      background: url("sprites/desert.png");
      background-size: cover;
    }
        
    .start-section .elevator-img {
      position: fixed;
      bottom: 0;
      max-height: 60vh;
      max-width: 100%;
      height: 100%;
      object-fit: contain;
      cursor: var(--cursor-pointer);
    }

    .elevator-section {
      container-type: inline-size;
      aspect-ratio: 1 / 1;
      width: min(100vw, 100vh);
      height: min(100vw, 100vh);
      background: url(sprites/elevator_sbg.png);
      background-size: cover;
      animation: fadeIn 1s;
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
      }
      100% {
        opacity: 1;
      }
    }

    .elevator-section .rob-img {
      position: absolute;
      bottom: 10cqi;
      height: 30cqi;
      object-fit: contain;
      cursor: var(--cursor-pointer);
    }

    .elevator-section .elevator-button-img {
      position: absolute;
      bottom: 42cqi;
      right: 10cqi;
      width: 15cqi;
      object-fit: contain;
      cursor: var(--cursor-pointer);
    }

    .elevator-section .elevator-speaker-grill-img {
      position: absolute;
      bottom: 65cqi;
      right: 10cqi;
      width: 15cqi;
      object-fit: contain;
    }

    .elevator-section dialog {
      background-color: black;
      color: white;
      border: 1cqw solid white;
      width: 80cqw;
      min-height: 10cqh;
      font-size: 2rem;
      outline: none;
    }

    .whirring {
      animation: whirr 200ms infinite;
    }

    @keyframes whirr {
      0% {
        transform: translate(1cqw, 1cqw);
      }
      80% {
        transform: translate(-1cqw, -1cqw);
      }
      100% {
        transform: translate(0cqw, 0cqw);
      }
    }
  </style>

  <body>
    <main>
      <section class="start-section">
        <img class="elevator-img" src="sprites/elevator/elevator1.png" onclick="processElevatorClick()"/>
      </section>
      <section class="elevator-section hidden">
        <img class="rob-img" src="sprites/rob/rob1.png" onclick="showDialog()">
        <img class="elevator-button-img" src="sprites/elevator-button.png" onclick="processElevatorButtonClick()">
        <img class="elevator-speaker-grill-img" src="sprites/elevator-speaker-grill.png">
        <dialog closedby="any">
          <p>Hey what's uppp... I'm Rob... Rob the rock... haha!</p>
        </dialog>
      </section>
    </main>
  </body>
</html>
